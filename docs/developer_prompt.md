
# برومبة للمطور: استراتيجية ذكية لجلب وتخزين بيانات المباريات من جانب العميل

**الوصف:**
هذه الخطة تنفذ "محاكاة" من جانب العميل (Client-Side) لنظام إدارة بيانات فعال وموفر للموارد، مستوحاة من بنية الخادم الخلفي المتقدمة. الهدف هو تقليل استدعاءات API وتوفير تجربة مستخدم سريعة وسلسة من خلال جلب البيانات فقط عند الضرورة، وتخزينها مؤقتًا بذكاء، وتنفيذ تحديثات تفاضلية على الواجهة، وكل ذلك يتم داخل مكون `MatchesScreen.tsx` في بيئة Next.js.

**1. المبادئ الأساسية للنظام:**

-   **الجلب عند الطلب (On-Demand Fetching):** لا يتم جلب بيانات مباريات أي يوم إلا عندما يقوم المستخدم باختيار ذلك اليوم لأول مرة خلال جلسة استخدامه للتطبيق.
-   **تخزين مؤقت على مستوى الجلسة (Session-level Caching):** بمجرد جلب بيانات يوم معين، يتم تخزينها في ذاكرة المكون (`useState<Map<...>>`). هذا يجعل العودة لنفس اليوم مرة أخرى فورية ولا تتطلب أي طلبات جديدة من الشبكة.
-   **تحديثات حية وذكية (Intelligent Live Updates):** يتم استخدام مؤقت زمني (`setInterval`) لإعادة جلب البيانات بشكل دوري **فقط** لليوم الذي يعرضه المستخدم حاليًا.
-   **تحديث المباريات الحية فقط:** آلية التحديث الحي تقوم بجلب بيانات المباريات التي لم تنتهِ بعد (`LIVE`, `1H`, `HT`, إلخ) فقط، مما يقلل بشكل كبير من حجم البيانات المطلوبة من API-Football في كل تحديث.
-   **تحديثات تفاضلية (Delta Updates):** بعد جلب البيانات الجديدة للمباريات الحية، يقوم الكود بمقارنتها بالبيانات المخزنة مؤقتًا. لن يتم تحديث واجهة المستخدم إلا إذا كان هناك تغيير فعلي في حالة المباراة، نتيجتها، أو وقتها.
-   **الوعي بظهور الشاشة (Visibility Awareness):** لا يعمل مؤقت التحديثات الحية إلا عندما تكون شاشة المباريات (`MatchesScreen`) مرئية للمستخدم، مما يمنع أي استدعاءات API غير ضرورية في الخلفية.

**2. إدارة الحالة (State Management) داخل المكون:**

-   `selectedDateKey`: متغير من نوع `string` (بتنسيق `'yyyy-MM-dd'`) يمثل اليوم الذي يتم عرضه حاليًا.
-   `matchesCache`: متغير من نوع `Map`، حيث تكون المفاتيح هي تواريخ الأيام (`dateKey`) والقيم هي مصفوفة من بيانات المباريات (`FixtureType[]`) لذلك اليوم. هذا هو المخزن المؤقت الرئيسي للبيانات.
-   `loading`: متغير منطقي (`boolean`) يوضح ما إذا كان التطبيق يقوم حاليًا بجلب بيانات يوم كامل لأول مرة.

**3. خطوات التنفيذ المنطقية (The Logic Flow):**

1.  عندما يفتح المستخدم شاشة المباريات، يتم عرض تاريخ اليوم الحالي.
2.  يتم تفعيل `useEffect` الذي يتحقق مما إذا كانت بيانات اليوم الحالي موجودة في `matchesCache`.
3.  **إذا لم تكن موجودة:**
    *   يتم تعيين `loading` إلى `true`.
    *   يتم استدعاء الدالة `fetchAndProcessData` التي تقوم بجلب جميع مباريات اليوم من `api/football/fixtures?date=...`.
    *   بعد جلب البيانات وتصفيتها بناءً على مفضلات المستخدم، يتم تخزينها في `matchesCache`.
    *   يتم تعيين `loading` إلى `false`.
4.  **إذا كانت موجودة:**
    *   يتم عرض البيانات مباشرة من `matchesCache`، وتكون الواجهة فورية.
5.  **التحديثات الحية:**
    *   يتم تشغيل مؤقت `setInterval` كل 60 ثانية.
    *   يقوم المؤقت باستدعاء الدالة `updateLiveData`.
    *   تقوم `updateLiveData` بتحديد المباريات التي لم تنتهِ بعد من `matchesCache` وتطلب تحديثاتها فقط من API-Football باستخدام `fixtures?ids=...`.
    *   تتم مقارنة البيانات المحدثة بالبيانات القديمة، وإذا كان هناك أي فرق، يتم تحديث `matchesCache`، مما يؤدي إلى إعادة رسم الواجهة بسلاسة.
6.  عندما يغادر المستخدم شاشة المباريات، يتم إيقاف المؤقت الزمني تلقائيًا لتوفير الموارد.

هذه البرومبة تلخص البنية الجديدة التي تم تنفيذها، والتي تحاكي نظام الخادم الخلفي الذكي الذي اقترحته، ولكن ضمن قيود وقدرات الواجهة الأمامية.
